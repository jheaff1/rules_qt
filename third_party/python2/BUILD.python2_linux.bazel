load("@rules_foreign_cc//foreign_cc:defs.bzl", "configure_make")
# load("@rules_python//python:defs.bzl", "py_runtime_pair")

package(default_visibility = ["//visibility:public"])

filegroup(
    name = "all_srcs",
    srcs = glob(["**"]),
)

configure_make(
    name = "python2",
    configure_options = [
        "CFLAGS='-Dredacted=\"redacted\"'",
        "--with-openssl=$EXT_BUILD_DEPS/openssl",
        "--with-zlib=$EXT_BUILD_DEPS/zlib",
        "--enable-optimizations",
    ],
    # rules_foreign_cc defaults the install_prefix to "python". This conflicts with the "python" executable that is generated.
    install_prefix = "py_install",
    lib_source = ":all_srcs",
    out_binaries = [
        "python2.7",
    ],
    out_data_dirs = ["lib"],
    # Building these targets rather than the default prevents tests from being run, which take a while
    targets = [
        "build_all",
        "altinstall",
    ],
    deps = [
        "@openssl",
        "@zlib",
    ],
)

filegroup(
    name = "python2_exe",
    srcs = [":python2"],
    output_group = "python2.7",
)

# py_runtime(
#     name = "py2_runtime",
#     files = ["@python2"],
#     interpreter = "python2_bin",
#     python_version = "PY2",
# )

# py_runtime_pair(
#     name = "py_runtime_pair",
#     py2_runtime = ":py2_runtime",
#     py3_runtime = None,
# )
